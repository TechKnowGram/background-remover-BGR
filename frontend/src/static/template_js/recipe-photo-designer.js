var hd_req_obj={"image_url":"","source_image_width":"","source_image_height":"","output_image_width":"","output_image_height":"","is_image_downloaded":"0","is_hd":true,"template_details":{"type":"recipe_template","is_background_available":true,"background_image":"","background_color":"","is_plate_available":false,"plate_image":"","full_hd_image_path":"","full_hd_template_path":""}}
var obj_placeholder_without_plate=null;var obj_placeholder_with_plate=null;var obj_background=null;var obj_plate=null;var is_plate=false;var obj=null;var canvas_element=document.createElement('canvas');var img_obj=document.getElementById('mainImageElement');var _height=728;var _width=728;var _top=0;var _left=0;var url1=baseURL()+'/static/images/design_templates/recipe_photo_designer/placeholder.png';canvas_element.width=_width;canvas_element.height=_height;var canvas=new fabric.Canvas(canvas_element)
$(document).on('ready',function(e){$(window).bind("load",function(){setBackgroundImageFromUrl(baseURL()+'/static/images/design_templates/recipe_photo_designer/bg_image/1.jpg')
setPlaceholderImageFromUrl(baseURL()+'/static/images/design_templates/recipe_photo_designer/placeholder.png')});$(document).on('click','#btnUploadImage',function(e){$("#uploadImage").trigger("click");});loadTemplateAndBgImage()
$(document).on('click','.templateImage',function(event){var URL=$(this).attr('src');if(URL!=''){loadTemplate(baseURL()+URL)}});$(document).on('click','.bgImage',function(event){$('.bgImage').removeClass('active');$(this).addClass('active');setBackgroundImageFromUrl(baseURL()+$.trim($(this).attr('src')).replace("thumbnail","bg_image"));});$(document).on('change','#uploadImage',function(event){if(isImageProcessing==false){if(this.files[0]!='undefined'){filenameWithoutExt=this.files[0].name.split(/\.(?=[^\.]+$)/)[0]
uploadPlaceholderImage(this.files[0])}}else{alert("You can upload one image at a time")}});$(document).on('click','.chooseColor',function(e){var background_color=$(this).attr('style');background_color=$.trim(background_color.split(":")[1])
setBackgroundColor(background_color)});$(document).on('change','#showInputWithClear',function(e){var background_color=$('.sp-preview-inner').attr('style');background_color=$.trim(background_color.split(":")[1]).slice(0,-1)
if(background_color!='transparent'){setBackgroundColor(rgb2hex(background_color))}});$(document).on('click','.imgPlate',function(e){$('.imgPlate').removeClass('active');$(this).addClass('active');var url=$.trim($(this).attr('src'));if($(this).attr('is-plate')=='true'){is_plate=true;if(url!=''){uploadPlate(baseURL()+url)}}else{is_plate=false;if(url!=''){uploadPlate(baseURL()+url)}}});$(document).on('click','#btnDownloadPreview',function(e){this.href=canvas.toDataURL({format:'jpg',quality:0.8,})
this.download=filenameWithoutExt+'.png'});$(document).on('click','#btnDownloadHD',function(e){if(hd_req_obj.is_hd){hd_car_design_template(hd_req_obj)
$('#btnDownloadHD').addClass('btn-hd');}});});function setPlaceholderImageFromFile(file){var logoBlobURL=URL.createObjectURL(file);url1=logoBlobURL;setPlaceholderImageFromUrl(logoBlobURL)
activate_download_button()}
function setBackgroundImageFromUrl(url){fabric.Image.fromURL(url,function(img){canvas.setBackgroundImage(img,canvas.renderAll.bind(canvas),{scaleX:canvas.width/img.width,scaleY:canvas.height/img.height});img_obj.src=canvas.toDataURL('png');hd_req_obj.template_details.is_background_available=true;hd_req_obj.template_details.background_image=url;});}
function setPlaceholderImageFromUrl(url){if(obj_placeholder_without_plate!=null){canvas.remove(obj_placeholder_without_plate).renderAll();}
if(obj_placeholder_with_plate!=null){canvas.remove(obj_placeholder_with_plate).renderAll();}
var templateScaleWidth=460;var templateScaleHeight=460;if(is_plate){var templateScaleWidth=300;var templateScaleHeight=300;}
fabric.Image.fromURL(url,function(img){if(img.width>img.height){var scale=templateScaleWidth/img.width;var oImg=img.set({top:canvas.height/2-img.height*scale/2,left:(canvas.width/2)-(templateScaleWidth/2)}).scale(scale);}else{var scale=templateScaleHeight/img.height;var oImg=img.set({top:canvas.height/2-templateScaleHeight/2,left:(canvas.width/2)-(img.width*(scale))/2}).scale(scale);}
canvas.add(oImg).renderAll();obj_placeholder_without_plate=oImg;img_obj.src=canvas.toDataURL('png');view_template_thumbnail(url)});}
function setBackgroundColor(colorCode){canvas.setBackgroundImage(null);canvas.backgroundColor=colorCode;canvas.renderAll();img_obj.src=canvas.toDataURL('png');hd_req_obj.template_details.is_background_available=false;hd_req_obj.template_details.background_color=colorCode;}
function uploadPlate(url){if(obj_plate!=null){canvas.remove(obj_plate).renderAll();}
if(obj_placeholder_with_plate!=null){canvas.remove(obj_placeholder_with_plate).renderAll();}
if(obj_placeholder_without_plate!=null){canvas.remove(obj_placeholder_without_plate).renderAll();}
if(is_plate){hd_req_obj.template_details.is_plate_available=true;hd_req_obj.template_details.plate_image=url;var templateScaleWidth=600;var templateScaleHeight=600;fabric.Image.fromURL(url,function(img){var scale=templateScaleWidth/img.width;var oImg=img.set({top:canvas.height/2-img.height*scale/2,left:canvas.width/2-img.width*scale/2}).scale(scale);canvas.add(oImg).renderAll();obj_plate=oImg;img_obj.src=canvas.toDataURL('png');templateScaleWidth=300;templateScaleHeight=300;if(obj_placeholder_with_plate!=null){fabric.Image.fromURL(url1,function(img){var scale=templateScaleWidth/img.width;var oImg=img.set({top:canvas.height/2-img.height*scale/2,left:canvas.width/2-img.width*scale/2}).scale(scale);canvas.add(oImg).renderAll();obj_placeholder_with_plate=oImg;img_obj.src=canvas.toDataURL('png');});}else{templateScaleWidth=300;templateScaleHeight=300;fabric.Image.fromURL(url1,function(img){var scale=templateScaleWidth/img.width;var oImg=img.set({top:canvas.height/2-img.height*scale/2,left:canvas.width/2-img.width*scale/2}).scale(scale);canvas.centerObject(oImg);canvas.add(oImg).renderAll();obj_placeholder_with_plate=oImg;img_obj.src=canvas.toDataURL('png');});}});}else{hd_req_obj.template_details.is_plate_available=false;hd_req_obj.template_details.plate_image='';var templateScaleWidth=460;var templateScaleHeight=460;fabric.Image.fromURL(url1,function(img){var scale=templateScaleWidth/img.width;var oImg=img.set({top:canvas.height/2-img.height*scale/2,left:canvas.width/2-img.width*scale/2}).scale(scale);canvas.add(oImg).renderAll();obj_placeholder_with_plate=oImg;img_obj.src=canvas.toDataURL('png');});}}
function baseURL(){return window.location.origin;}
function loadTemplateAndBgImage(){var templateImageList=['1.png','2.png','3.png','4.png','5.png','6.png','7.png','8.png'];templateImageList.forEach(function(image,i){var SRC="/static/images/design_templates/recipe_photo_designer/plate/"+image
if(i==0){$('#divPlateImage').append(`<img src="`+SRC+`" alt="Plate Bg" class="imgPlate active" is-plate="false">`)}
else{$('#divPlateImage').append(`<img src="`+SRC+`" alt="Plate Bg" class="imgPlate" is-plate="true">`)}});var templateImageList=['1.jpg','2.jpg','3.jpg','4.jpg','5.jpg','6.jpg','7.jpg','8.jpg','9.jpg','10.jpg','11.jpg','12.jpg','13.jpg','14.jpg','15.jpg','16.jpg'];templateImageList.forEach(function(image,i){var SRC="/static/images/design_templates/recipe_photo_designer/thumbnail/"+image
if(i==0){$('#divBgImage').append(`<img class="bgImage active" src="`+SRC+`">`)}
else{$('#divBgImage').append(`<img class="bgImage" src="`+SRC+`">`)}});}
function uploadPlaceholderImageStatic(inputImage){progressbar_show_hide(false)
var csrftoken=$('meta[name=csrf-token]').attr('content');var formdata=new FormData();formdata.append("source_image_file",inputImage);formdata.append("is_design_template",1);$('#canvasProgressBar').css('display','');$.ajaxSetup({beforeSend:function(xhr,settings){if(!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)){xhr.setRequestHeader("X-CSRFToken",csrftoken)}}});$.ajax({url:'/upload_image',type:'POST',processData:false,contentType:false,data:formdata,xhr:function(){var xhr=new window.XMLHttpRequest();xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){var current_progress=evt.loaded/evt.total
current_progress=parseInt(current_progress*100)
$('#uploadImageInnerProgressBar').css('width',current_progress.toString()+'%')
if(current_progress===100){progressbar_show_hide()}}},false);return xhr;},success:function(data){$('#canvasProgressBar').css('display','none');data=JSON.parse(data)
var preview_image_url=baseURL()+data.preview_size_output_image
setPlaceholderImageFromUrl(preview_image_url)
view_template_thumbnail(preview_image_url)
url1=preview_image_url;activate_download_button()},error:function(err){}});}
function progressbar_show_hide(isHide=true){if(isHide){$('#uploadImageProgressBar').css('display','none')}
else{$('#uploadImageProgressBar').css('display','')}}
var rgb2hex=(rgb)=>`#${rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map(n=>parseInt(n,10).toString(16).padStart(2,'0')).join('')}`